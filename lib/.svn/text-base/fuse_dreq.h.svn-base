/*
 * =====================================================================================
 *
 *       Filename:  fuse_dreq.h
 *
 *    Description:  fuse disk_req definition
 *
 *        Version:  1.0
 *        Created:  10/18/2011 01:17:37 PM
 *       Revision:  none
 *       Compiler:  gcc
 *
 *         Author:  Heaven (), zhanwenhan@163.com
 *        Company:  NDSL
 *
 * =====================================================================================
 */
#ifndef __FUSE_D_REQ_H_
#define __FUSE_D_REQ_H_

#include "list.h"

//#include "heap.h"

#include <stdint.h>
#include <unistd.h>

enum disk_type
{
    DISK_OPEN = 0,
    DISK_READ,
    DISK_WRITE,
    DISK_SEEK,
    DISK_CLOSE,
    LOG_WRITE
};

enum disk_state
{
    DISK_REQ_SENT = 0,
    DISK_REQ_RUNNING,
    DISK_REQ_FINISH
};

//for read and write argument
struct read_arg {
char *path;
off_t offset;
size_t size;
char *buf;
};

//for open and close argument
struct open_arg {
char name[0];
};
//for seek
struct seek_arg {
off_t offset;
char name[0];
};
//open file table
/*  
struct open_file {
    int fd;//file's fd,if open
    int32_t ctr;//file's reference count
    struct hlist_node next;//hash finish map between filename and fd
    char name[0];//file's name
};
*/
struct disk_req;

struct disk_lowlevel_ops {
    void (*func)(struct disk_req *,void *);
    const char *name;
};


typedef void (*dr_func_t)(struct disk_req *,void *);

struct disk_req {
    uint64_t unique;
    enum disk_state state;
    enum disk_type type;
    void *owner;//who create this req
    dr_func_t cb;//when the request is finished,call this function
    int32_t ctr;
//    union {
    struct list list;//log request
//    struct heap_node node;//disk write/read request
//    };
    struct list req_list;//depend on this req
    void *in;
    void *out;
    struct fuse_sock *next;
    int error;
};

void disk_free_req(struct disk_req *);
int disk_allocate_req(struct fuse_sock *next,enum disk_type,void *owner,struct disk_req **_req);
uint64_t disk_get_unique();
void disk_send(struct fuse_sock *next,struct disk_req *req);

#endif
